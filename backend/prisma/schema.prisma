// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================
model User {
  id        String   @id @default(cuid())
  email     String
  password  String
  firstName String
  lastName  String
  phone     String?
  role      Role     @default(CUSTOMER)
  isActive  Boolean  @default(true)

  // White-label
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  orders    Order[]
  cart      Cart?
  addresses Address[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
  @@map("users")
}

enum Role {
  SUPER_ADMIN  // Platform owner (you)
  ADMIN        // Client admin
  CUSTOMER     // End user
}

// ==================== PRODUCTS ====================
model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String
  description String?
  image       String?
  parentId    String?
  parent      Category? @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")
  products    Product[]
  isActive    Boolean   @default(true)

  // White-label: Each client has their own categories
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([slug, tenantId])
  @@index([tenantId])
  @@map("categories")
}

model Product {
  id              String   @id @default(cuid())
  name            String
  slug            String
  description     String   @db.Text
  shortDescription String?

  // Pricing
  price           Decimal  @db.Decimal(10, 2)
  compareAtPrice  Decimal? @db.Decimal(10, 2)
  costPrice       Decimal? @db.Decimal(10, 2)

  // Inventory
  sku             String
  stock           Int      @default(0)
  trackInventory  Boolean  @default(true)
  lowStockThreshold Int?   @default(10)

  // Media
  images          String[]
  thumbnail       String?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Product Details (for peptides)
  chemicalName    String?
  casNumber       String?
  purity          String?
  molecularFormula String?
  sequence        String?  @db.Text
  productForm     String?  @default("Lyophilized Powder")
  researchNotice  String?  @db.Text

  // Relations
  category        Category @relation(fields: [categoryId], references: [id])
  categoryId      String
  orderItems      OrderItem[]
  cartItems       CartItem[]
  bundleProducts  BundleProduct[]

  // Status
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)

  // White-label
  tenantId        String   // Each client has their own products
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([slug, tenantId])
  @@unique([sku, tenantId])
  @@index([tenantId])
  @@map("products")
}

// ==================== CART ====================
model Cart {
  id        String     @id @default(cuid())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String     @unique
  items     CartItem[]

  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([tenantId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  quantity  Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ==================== ORDERS ====================
model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique

  // Customer
  user            User          @relation(fields: [userId], references: [id])
  userId          String

  // Items
  items           OrderItem[]

  // Pricing
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @db.Decimal(10, 2) @default(0)
  shipping        Decimal       @db.Decimal(10, 2) @default(0)
  discount        Decimal       @db.Decimal(10, 2) @default(0)
  total           Decimal       @db.Decimal(10, 2)

  // Status
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)

  // Shipping
  shippingAddress Json
  billingAddress  Json?
  trackingNumber  String?

  // Payment
  paymentMethod   String?
  paymentId       String?

  // Notes
  customerNote    String?
  adminNote       String?

  // White-label
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([tenantId])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     String
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId   String?

  // Snapshot of product at time of order
  productName String
  sku         String
  quantity    Int
  price       Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_PAID
  REFUNDED
  FAILED
}

// ==================== ADDRESS ====================
model Address {
  id          String  @id @default(cuid())
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  fullName    String
  phone       String
  addressLine1 String
  addressLine2 String?
  city        String
  state       String
  zipCode     String
  country     String  @default("Bangladesh")

  isDefault   Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("addresses")
}

// ==================== WHITE-LABEL CONFIG ====================
model Tenant {
  id          String   @id @default(cuid())

  // Business Info
  name        String   // Business name
  slug        String   @unique // URL slug
  domain      String?  @unique // Custom domain (optional)

  // Branding
  logo        String?
  favicon     String?
  primaryColor String? @default("#3b82f6")

  // Contact
  email       String
  phone       String?
  address     String?

  // Settings
  currency    String   @default("BDT")
  taxRate     Decimal  @db.Decimal(5, 2) @default(0)

  // Payment Gateway Config (encrypted)
  stripeKey   String?
  sslcommerzKey String?

  // Email Config
  emailFrom   String?
  contactNotificationEmail String?  // Email to receive contact form notifications
  orderNotificationEmail   String?  // Email to receive order notifications
  smtpConfig  Json?

  // Status
  isActive    Boolean  @default(true)
  plan        Plan     @default(BASIC)

  // Relations
  users       User[]
  categories  Category[]
  products    Product[]
  carts       Cart[]
  orders      Order[]
  media       Media[]
  bundles       Bundle[]
  qualityImages QualityImage[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tenants")
}

enum Plan {
  BASIC
  PRO
  ENTERPRISE
}

// ==================== MEDIA ====================
model Media {
  id           String    @id @default(cuid())
  filename     String    // Stored filename (with timestamp)
  originalName String    // Original uploaded filename
  mimeType     String    // MIME type (image/jpeg, video/mp4, etc.)
  size         Int       // File size in bytes
  url          String    // Full URL path to file
  type         MediaType // IMAGE or VIDEO

  // White-label
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId])
  @@index([type])
  @@map("media")
}

enum MediaType {
  IMAGE
  VIDEO
}

// ==================== CONTACT ====================
model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String   @db.Text
  tenantId  String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([isRead])
  @@map("contacts")
}

// ==================== BUNDLES ====================
model Bundle {
  id            String          @id @default(cuid())
  name          String
  slug          String
  description   String?         @db.Text
  image         String?
  discount      Decimal         @db.Decimal(5, 2)

  // Products in bundle
  products      BundleProduct[]

  // Pricing
  originalPrice Decimal         @db.Decimal(10, 2)
  finalPrice    Decimal         @db.Decimal(10, 2)

  // Status
  isActive      Boolean         @default(true)

  // White-label
  tenantId      String
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([slug, tenantId])
  @@index([tenantId])
  @@map("bundles")
}

model BundleProduct {
  id        String  @id @default(cuid())
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  bundleId  String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  quantity  Int     @default(1)

  @@unique([bundleId, productId])
  @@map("bundle_products")
}

// ==================== QUALITY IMAGES ====================
model QualityImage {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  imageUrl    String
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  // White-label
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([order])
  @@map("quality_images")
}
